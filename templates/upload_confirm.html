<!DOCTYPE html>
<html lang="ja">
    
    <head>
        <meta charset="UTF-8">
        <title>アップロード確認 - 座標指定付き</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
            background: #1c1c1c;
            color: white;
        }
        
        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        /* マップ画像クリック用エリア */
        #mapContainer {
            position: relative;
            cursor: pointer;
            /* ポインターに統一 */
            margin-bottom: 20px;
        }
        
        #mapImage {
            /* 幅・高さは固定せず自然なサイズ */
            display: block;
        }
        
        #marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }
        
        form {
            background: #2b2b2b;
            padding: 15px;
            border-radius: 6px;
            max-width: 500px;
            width: 100%;
        }

        form input,
        form select,
        form textarea,
        form button {
            width: 100%;
            margin-bottom: 10px;
            padding: 6px;
            border: none;
            border-radius: 4px;
        }

        img {
            max-width: 100%;
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 4px;
        }

        textarea {
            resize: none;
            font-size: 110%;
            width: 100%;
            height: 80px;
            background: #1c1c1c;
            color: white;
            border: 1px solid #444;
            padding: 6px;
        }

    </style>
</head>

<body>
    <div class="center-container">
        <h1>アップロード確認画面</h1>

        <!-- マップ表示とマーカー用エリア -->
        <div id="mapContainer">
            <img id="mapImage" src="/static/maps/{{ form_data.map_name }}.png">
            <div id="marker"></div>
        </div>
        <form method="POST" action="{{ url_for('upload_confirm') }}">
            <!-- 確認用に読み取り専用表示 -->
            <label>マップ名:</label>
            <input type="text" value="{{ form_data.map_name_jp }}" readonly>
            <input type="hidden" name="map_name" value="{{ form_data.map_name }}">
            <!--座標-->
            <input type="hidden" name="marker_x" value="{{ form_data.marker_x }}" readonly>
            <input type="hidden" name="marker_y" value="{{ form_data.marker_y }}" readonly>

            <label>エージェント:</label>
            <input type="text" value="{{ form_data.agent_name_jp}}" readonly>
            <input type="hidden" name="agent_name" value="{{ form_data.agent_name }}">

            <label>着地点:</label>
            <input type="text" name="site" value="{{ form_data.site }}" readonly>

            <label>説明文:</label>
            <textarea name="description" readonly>{{ form_data.description }}</textarea>

            <label>定点画像:</label>
            <img name="file" src="{{ filepath }}" alt="定点画像">
            <input type="hidden" name="image_src" value="{{ filepath }}">

            {% if is_poition %}
            <label>立ち位置画像:</label>
            <img name="stand_file" src="{{ stand_filepath }}" alt="立ち位置画像">
            <input type="hidden" name="stand_image_src" value="{{ stand_filepath }}">
            <label>立ち位置説明文:</label>
            <textarea name="stand_description" readonly>{{ form_data.stand_description }}</textarea>
            {% endif %}

            <div class="d-flex gap-2 mt-3">
                <!-- 修正するボタン -->
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/upload'">
                    修正する
                </button>

                <!-- 確定ボタン -->
                <button type="submit" class="btn btn-primary">確定</button>
            </div>
        </form>
    </div>
    <script>
        window.addEventListener("DOMContentLoaded", () => {
            const marker = document.getElementById("marker");
            const img = document.getElementById("mapImage");

            // Jinja2から受け取ったマーカー座標（100分率）
            const xRatio = {{ form_data.marker_x | safe
        }};
        const yRatio = {{ form_data.marker_y | safe }};

        // 画像の読み込みが終わってから座標を計算
        img.addEventListener("load", () => {
            const x = (xRatio / 100) * img.width;
            const y = (yRatio / 100) * img.height;

            marker.style.left = x + "px";
            marker.style.top = y + "px";
            marker.style.display = "block";
        });
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
</body>

</html>