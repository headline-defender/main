<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>定点表示画面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1e1f2f;
            /* ダークネイビー／グレー */
            color: #e0e0e0;
        }

        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .btn {
            width: auto;
        }

        .required {
            color: red;
            font-weight: bold;
        }

        /* マップ画像コンテナ */
        #mapContainer {
            position: relative;
            cursor: default;
            margin-bottom: 20px;
            display: inline-block;
        }

        #mapImage {
            display: block;
            max-width: 90vw;
            height: auto;
        }

        /* マーカー */
        .marker-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: auto;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="center-container">
        <br>
        <h1>{{ agent_name_jp }}定点表示画面</h1>
        <button class="btn btn-secondary mb-3" onclick="location.href='/'" style="margin-left: 80%;">定点一覧へ</button>

        <!-- マップ表示＆複数マーカー -->
        <div id="mapContainer">
            <img id="mapImage" src="{{ map_img_path }}" alt="マップ画像">
            {% for item in lineups %}
            <span class="marker-dot" style="left: {{ item.marker_x }}%; top: {{ item.marker_y }}%;"
                onclick="openModal({{ item.lineup_id }})"
                title="{{ item.site }} / {{ item.agent_name }} | {{ item.created_at }}"></span>
            {% endfor %}
        </div>
    </div>
    <!-- モーダル -->
    <div class="modal fade" id="markerModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">定点詳細</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <!-- JSで動的に内容を埋めます -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const lineups = {{ lineups | tojson }};
        const lineupImages = {{ lineup_images | tojson }};
        lineupImages.reverse();
        function openModal(id) {
            const imgs = lineupImages.filter(img => img.lineup_id === id);
            const container = document.getElementById('modalContent');
            container.innerHTML = '';  // 既存内容クリア

            const modalTitle = document.querySelector('#markerModal .modal-title');
            const lineupItem = lineups.find(l => l.lineup_id === id);
            modalTitle.textContent = lineupItem ? lineupItem.site : '定点詳細';

            imgs.forEach(img => {
                const div = document.createElement('div');
                div.classList.add('mb-3');
                div.innerHTML = `
                <img src="${img.image_path}" class="img-fluid rounded mb-2" alt="">
                <p>${img.description.replace(/(\r\n|\n|\r)/g, '<br>')}</p>
                `;
                container.appendChild(div);
            });
            const modal = new bootstrap.Modal(document.getElementById('markerModal'));
            modal.show();
        }
    </script>
</body>

</html>